<html>
<head>
    <title>Bank Connect</title>
    <script src="/js/app.js"></script>
    <script src="/js/helpers.js"></script>
    <script src="/js/polyfills/promise-polyfill.min.js"></script>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
<h2 id="loading">Loading data...</h2>
<div id="content">
    <div id="header">
        <h2 id="headerTitle">Connect your account</h2>
        <a href="#" id="closeButton"></a>
        <a href="#" id="backButton"></a>
    </div>
    <div id="statusContainer" class="status-container">
        <div id="statusIcon">
            <div id="connectionLoader" class="loader-container">
                <div id="connectionSpinner" class="spinner"></div>
                <svg id="connectionCheckmark" class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="5 0 40 36">
                    <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
                <svg id="connectionCross" class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="5 0 40 52">
                    <path class="checkmark__cross" d="M 15,20 L 35,40 M 35,20 L 15,40" />
                </svg>
            </div>
        </div>
        <h2 id="statusTitle"></h2>
        <div id="statusMessage">Logging on securely</div>
        <!-- Multiple ids of footer, needs refactor -->
        <div id="statusFooter" class="footer">
            <button id="doneBtn" class="button footer-button hidden">Done</button>
            <button id="retryBtn" class="button footer-button error-button hidden">Try again</button>
        </div>
    </div>
    <form id="credentialsForm" class="credentials-form" action="">
        <img id="bankLogo" alt="">
        <div class="input-container-right">
            <span class="ico-lock"></span>
            <input id="usernameInput" title="Username" type="text"/>
        </div>
        <div class="input-container-right">
            <span class="ico-lock"></span>
            <input id="passwordInput" title="Password" type="password"/>
        </div>
        <div id="securityInputContainer" class="input-container-right">
            <span class="ico-lock"></span>
            <input id="securityInput" title="Security code" type="password"/>
        </div>
        <div class="tag-line">
            <div class="tag-line-icon">
                <svg viewBox="0 0 40 51" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                    <!-- Generator: Sketch 49.3 (51167) - http://www.bohemiancoding.com/sketch -->
                    <desc>Fortress.</desc>
                    <defs></defs>
                    <g class="fortress" id="fortress" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                        <polyline id="Path-2" stroke="#989898" points="15.1278238 45.4063067 0.994962221 45.4063067 0.994962221 36.5691888 5.00931945 32.0380849 5.00931945 13.9948533 2.00831457 10.0185719 2.00831457 1 7.00827656 1 7.00827656 5.0193807 11.5248266 5.0193807 11.5248266 1 17.4916611 1 17.4916611 5.0193807 22.0069807 5.0193807 22.0069807 1 27.017014 1 27.017014 10.0185719 24 13.9948533 24 22.0072684"></polyline>
                        <path d="M1.5,36.3422869 L5.5,36.3422869" id="Line-2" stroke="#989898" stroke-linecap="square"></path>
                        <path d="M8.49751444,36.3422869 L13.502349,36.3422869" id="Line-2" stroke="#989898" stroke-linecap="square"></path>
                        <path d="M5.5,32.0733167 L13.5113706,32.0733167" id="Line-2" stroke="#989898" stroke-linecap="square"></path>
                        <path d="M2.58800358,10.3519212 L17.5007352,10.3519212" id="Line-2" stroke="#989898" stroke-linecap="square"></path>
                        <path d="M5.5,14.317551 L23.5009246,14.317551" id="Line-2" stroke="#989898" stroke-linecap="square"></path>
                        <path d="M20.498146,10.3519212 L26.4127316,10.3519212" id="Line-2" stroke="#989898" stroke-linecap="square"></path>
                        <g id="Group-2" transform="translate(15.000000, 22.000000)" stroke="#40BBBD">
                            <path d="M0.475176217,6.05088863 C0.475176217,15.0565221 0.475176217,19.5593388 0.475176217,19.5593388 C0.475176217,24.7722985 9.09085729,28.2156647 12.0085563,28.1938942 C17.7915849,28.1507438 23.5419364,24.7174985 23.5419364,19.387225 C23.5419364,15.8337093 23.5419364,11.3882639 23.5419364,6.05088863 L12.0085563,0.815007598 L0.475176217,6.05088863 Z" id="Path-3"></path>
                            <g id="Group" transform="translate(7.000000, 9.000000)">
                                <path d="M2.44384766,5.42965492 L7.44384766,5.42965492" id="Line-2" stroke-linecap="square"></path>
                                <path d="M0.728145814,10.9888191 L9.29624543,10.9888191 L9.29624543,5.42899351 L7.92635053,5.42899351 L7.92635053,1.57555204 C6.97477969,0.525184015 6.00339472,5.68434189e-14 5.01219562,5.68434189e-14 C4.02099652,5.68434189e-14 3.02821261,0.525184015 2.0338439,1.57555204 L2.0338439,5.42899351 L0.728145814,5.42899351 L0.728145814,10.9888191 Z" id="Path-4"></path>
                            </g>
                        </g>
                    </g>
                </svg>
            </div>
            <div class="tag-line-description">
                <h4>Bank level security</h4>
                <p>
                    We employ state of the art security practies meeting the
                    highest level of standards by leading financial institutions.
                </p>
            </div>
        </div>
        <div id="footer" class="footer">
            <button id="submitBtn" class="button footer-button">Connect</button>
        </div>
    </form>
</div>
<div id="errorContainer"></div>
<script src="/js/API.js"></script>
<script>
    document.getElementById("loading").style.display = "block";
    document.getElementById("content").style.display = "none";
    setTimeout(function () {
        document.getElementById("submitBtn").classList.add("footer-button-active");
    });
    document.getElementById("securityInputContainer").style.display = "none";
    document.getElementById("backButton").style.display = "block";

    var queryVars = parseQueryVariables(),
        institutionId = queryVars.institution_id,
        userId = queryVars.user_id,
        accessToken = queryVars.access_token,
        showClose = queryVars["show_close"] && queryVars["show_close"] === "true",
        form = document.getElementById("credentialsForm"),
        errorContainer = document.getElementById("errorContainer"),
        error = checkAccessToken(accessToken);

    if (error) {
        document.getElementById("loading").style.display = "none";
        window.errorContainer.innerHTML = error;
    } else {
        if (!institutionId) {
            throw new Error("No institution id provided");
        }

        API.loadInstitution(institutionId, accessToken).then(function (institution) {
            renderInstitution(institution, userId, accessToken);
        });

        var formHandler = function (e) {
            e.preventDefault();

            var username = document.getElementById("usernameInput").value.trim(),
                password = document.getElementById("passwordInput").value.trim(),
                security = document.getElementById("securityInput").value.trim();

            if (!username) {
                document.getElementById("errorContainer").innerHTML = "No username provided";
                return;
            }

            if (!password) {
                document.getElementById("errorContainer").innerHTML = "No password provided";
                return;
            }

            API.createUserConnection(
                accessToken,
                userId,
                institutionId,
                username,
                password,
                security
            ).then(function (jobData) {
                setTimeout(checkJobStatus.bind(undefined, accessToken, jobData), 100);
            }).catch(function(err) {
                document.getElementById("errorContainer").innerHTML = err.message;
            });

            showLoadingScreen();
        };

        form.addEventListener("submit", formHandler);
        document.getElementById("submitBtn").addEventListener("click", formHandler);
        document.getElementById("backButton").addEventListener("click", function(e) {
            e.preventDefault();
            window.location.href = "/?"+stringifyQueryParams(queryVars);
        });
        document.getElementById("retryBtn").addEventListener("click", function(e) {
            e.preventDefault();
            window.location.reload();
        });
        document.getElementById("closeButton").addEventListener("click", function (e) {
            e.preventDefault();

            sendEventNotification("cancellation");
        });

    //setTimeout(showConsentScreen, 1500)
    //setTimeout(showLoadingScreen, 4500)
    }

</script>
</body>
</html>