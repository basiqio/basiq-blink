<html>
<head>
    <title>Login to Qantas</title>
    <script src="/js/app.js"></script>
    <script src="/js/polyfills/promise-polyfill.min.js"></script>
    <link rel="stylesheet" href="/style.css">
</head>
<body>

<h2 id="loading">Loading data...</h2>
<div id="content">
    <h2 id="title"><a id="backLink" class="back-link" href="/"><</a></h2>
    <h5 id="serviceName"></h5>
    <form id="form" action="">
        <input id="usernameInput" title="Username" type="text"/>
        <input id="passwordInput" title="Password" type="password"/>
        <button id="submitBtn" class="button">Submit</button>
        <button id="cancelBtn" class="button">Cancel</button>
    </form>
</div>
<div id="errorContainer"></div>

<script src="/js/API.js"></script>
<script>
    document.getElementById("loading").style.display = "block";
    document.getElementById("content").style.display = "none";

    var queryVars = parseQueryVariables(),
        institutionId = queryVars.institution_id,
        userId = queryVars.user_id,
        accessToken = queryVars.access_token,
        form = document.getElementById("form"),
        errorContainer = document.getElementById("errorContainer");

    if (!institutionId) {
        throw new Error("No institution id provided");
    }

    API.loadInstitution(institutionId, accessToken).then(function (institution) {
        renderInstitution(institution, userId, accessToken);
    });

    var formHandler = function (e) {
        e.preventDefault();

        API.createUserConnection(
            accessToken,
            userId,
            institutionId,
            document.getElementById("usernameInput").value,
            document.getElementById("passwordInput").value
        ).then(function (jobData) {
            setTimeout(checkJobStatus.bind(undefined, jobData), 100);
        })
    };

    function checkJobStatus(jobData) {
        API.checkJobStatus(accessToken, jobData.id).then(function (resp) {
            console.log(resp);
            var steps = resp.steps;

            for (var step in steps) {
                if (steps[step].title === "verify-credentials") {
                    switch (steps[step].status) {
                        case "failed":
                            console.log("Credentials step has failed", steps[step]);

                            return sendEventNotification("connection", {
                                success: false,
                                data: steps[step].result
                            });
                            break;
                        case "success":
                            var url = steps[step].result.url,
                                connectionId = url.substr(url.lastIndexOf("/") + 1);

                            console.log("Credentials step is successfull");

                            return sendEventNotification("connection", {
                                success: true,
                                data: {
                                    id: connectionId
                                }
                            });
                            break;
                        case "pending":
                        case "in-progress":
                            setTimeout(checkJobStatus.bind(undefined, jobData), 1000);
                    }

                }
            }
        })
    }

    form.addEventListener("submit", formHandler);
    document.getElementById("submitBtn").addEventListener("click", formHandler);
    document.getElementById("cancelBtn").addEventListener("click", function (e) {
        e.preventDefault();

        sendEventNotification("cancellation");
    });

</script>
</body>
</html>