<html>
<head>
    <title>Bank Connect</title>
    <script src="/js/app.js"></script>
    <script src="/js/helpers.js"></script>
    <script src="/js/polyfills/promise-polyfill.min.js"></script>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
<h2 id="loading">Loading data...</h2>
<div id="content">
    <div id="header">
        <!-- <a id="backLink" class="back-link" href="/"><</a> -->
        <h2 id="headerTitle">Connect your account</h2>
        <a href="#" id="closeButton"></a>
        <a href="#" id="backButton"></a>
    </div>
    <div id="statusContainer" class="status-container">
        <div id="statusIcon">
            <div class="loader-container">
                <div class="spinner"></div>
            </div>
        </div>
        <h2 id="statusTitle"></h2>
        <div id="statusMessage">Logging on securely</div>
        <!-- Multiple ids of footer, needs refactor -->
        <div id="statusFooter" class="footer">
            <button id="doneBtn" class="button footer-button hidden">Done</button>
            <button id="retryBtn" class="button footer-button error-button hidden">Try again</button>
        </div>
    </div>
    <form id="credentialsForm" class="credentials-form" action="">
        <img id="bankLogo" alt="">
        <div class="input-container-right">
            <span class="ico-lock"></span>
            <input id="usernameInput" title="Username" type="text"/>
        </div>
        <div class="input-container-right">
            <span class="ico-lock"></span>
            <input id="passwordInput" title="Password" type="password"/>
        </div>
        <div id="securityInputContainer" class="input-container-right">
            <span class="ico-lock"></span>
            <input id="securityInput" title="Security code" type="password"/>
        </div>
        <div class="tag-line">
            <div class="tag-line-icon">
                <img src="fortress.svg" alt="We secure your information">
            </div>
            <div class="tag-line-description">
                <h4>Bank level security</h4>
                <p>
                    We employ state of the art security practies meeting the
                    highest level of standards by leading financial institutions.
                </p>
            </div>
        </div>
        <div id="footer" class="footer">
            <button id="submitBtn" class="button footer-button">Connect</button>
        </div>
    </form>
</div>
<div id="errorContainer"></div>
<script src="/js/API.js"></script>
<script>
    document.getElementById("loading").style.display = "block";
    document.getElementById("content").style.display = "none";
    document.getElementById("securityInputContainer").style.display = "none";
    document.getElementById("backButton").style.display = "block";

    var queryVars = parseQueryVariables(),
        institutionId = queryVars.institution_id,
        userId = queryVars.user_id,
        accessToken = queryVars.access_token,
        showClose = queryVars["show_close"] && queryVars["show_close"] === "true",
        form = document.getElementById("credentialsForm"),
        errorContainer = document.getElementById("errorContainer"),
        error = checkAccessToken(accessToken);

    if (error) {
        document.getElementById("loading").style.display = "none";
        window.errorContainer.innerHTML = error;
    } else {
        if (showClose) {
            document.getElementById("closeButton").style.display = "block";
            document.getElementById("closeButton").addEventListener("click", function (e) {
                e.preventDefault();

                sendEventNotification("cancellation");
            });
        }

        if (!institutionId) {
            throw new Error("No institution id provided");
        }

        API.loadInstitution(institutionId, accessToken).then(function (institution) {
            renderInstitution(institution, userId, accessToken);
        });

        var formHandler = function (e) {
            e.preventDefault();

            var username = document.getElementById("usernameInput").value.trim(),
                password = document.getElementById("passwordInput").value.trim(),
                security = document.getElementById("securityInput").value.trim();

            if (!username) {
                document.getElementById("errorContainer").innerHTML = "No username provided";
                return;
            }

            if (!password) {
                document.getElementById("errorContainer").innerHTML = "No password provided";
                return;
            }

            API.createUserConnection(
                accessToken,
                userId,
                institutionId,
                username,
                password,
                security
            ).then(function (jobData) {
                setTimeout(checkJobStatus.bind(undefined, accessToken, jobData), 100);
            }).catch(function(err) {
                document.getElementById("errorContainer").innerHTML = err.message;
            });

            showLoadingScreen();
        };

        form.addEventListener("submit", formHandler);
        document.getElementById("submitBtn").addEventListener("click", formHandler);
        document.getElementById("backButton").addEventListener("click", function(e) {
            e.preventDefault();
            window.location.href = "/?"+stringifyQueryParams(queryVars);
        });
        document.getElementById("retryBtn").addEventListener("click", function(e) {
            e.preventDefault();
            window.location.reload();
        });

    //setTimeout(showConsentScreen, 1500)
    //setTimeout(showLoadingScreen, 4500)
    }

</script>
</body>
</html>