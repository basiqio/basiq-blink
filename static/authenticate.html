<html>
<head>
    <title>Login to Qantas</title>
    <script src="/js/app.js"></script>
    <script src="/js/polyfills/promise-polyfill.min.js"></script>
    <link rel="stylesheet" href="/style.css">
</head>
<body>

<h2 id="loading">Loading data...</h2>
<div id="content">
    <h2 id="title"><a id="backLink" class="back-link" href="/"><</a></h2>
    <h5 id="serviceName"></h5>
    <form id="form" action="">
        <input id="usernameInput" title="Username" type="text"/>
        <input id="passwordInput" title="Password" type="password"/>
        <button id="submit" class="button">Submit</button>
        <button id="cancel" class="button">Cancel</button>
    </form>
</div>
<div id="errorContainer"></div>

<script src="/js/API.js"></script>
<script>
    document.getElementById("loading").style.display = "block";
    document.getElementById("content").style.display = "none";

    var queryVars = parseQueryVariables(),
        institutionId = queryVars.institution_id,
        userId = queryVars.user_id,
        accessToken = queryVars.access_token,
        form = document.getElementById("form"),
        submitBtn = document.getElementById("submit"),
        cancelBtn = document.getElementById("cancel"),
        errorContainer = document.getElementById("errorContainer");

    if (!institutionId) {
        console.error("No institution id provided");
    }

    API.loadInstitution(institutionId, accessToken).then(function (institution) {
        document.getElementById("loading").style.display = "none";
        document.getElementById("content").style.display = "block";
        if (institution.loginIdCaption) {
            //document.getElementById("usernameInputLabel").innerHTML = institution.loginIdCaption + ":";
            document.getElementById("usernameInput").setAttribute("placeholder", institution.loginIdCaption);
        }
        if (institution.passwordCaption) {
            //document.getElementById("passwordInputLabel").innerHTML = institution.passwordCaption + ":";
            document.getElementById("passwordInput").setAttribute("placeholder", institution.passwordCaption);
        }

        document.getElementById("title").innerHTML += "Login to " + institution.name;
        document.getElementById("serviceName").innerHTML = institution.serviceName;


        var complementaryColor = hexToComplimentary(institution.colors.primary, true);

        document.getElementById("backLink").setAttribute("href", "/?user_id=" + userId + "&access_token=" + accessToken);
        document.getElementById("backLink").style.color = complementaryColor;
        submitBtn.style.color = complementaryColor;
        cancelBtn.style.color = complementaryColor;
        document.body.style.color = complementaryColor;
        document.body.style.background = institution.colors.primary;
    });

    var formHandler = function (e) {
        e.preventDefault();

        console.log(form.children);

        API.createUserConnection(
            accessToken,
            userId,
            institutionId,
            document.getElementById("usernameInput").value,
            document.getElementById("passwordInput").value
        );
    };

    form.addEventListener("submit", formHandler);
    submitBtn.addEventListener("click", formHandler);
    cancelBtn.addEventListener("click", function (e) {
        e.preventDefault();

        window.location.replace("basiq://cancelation");
    });

    /* hexToComplimentary : Converts hex value to HSL, shifts
     * hue by 180 degrees and then converts hex, giving complimentary color
     * as a hex value
     * @param  [String] hex : hex value
     * @return [String] : complimentary color as hex value
     */
    function hexToComplimentary(hex, bw){
        if (hex.indexOf('#') === 0) {
            hex = hex.slice(1);
        }
        // convert 3-digit hex to 6-digits.
        if (hex.length === 3) {
            hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
        }
        if (hex.length !== 6) {
            throw new Error('Invalid HEX color.');
        }
        var r = parseInt(hex.slice(0, 2), 16),
            g = parseInt(hex.slice(2, 4), 16),
            b = parseInt(hex.slice(4, 6), 16);
        if (bw) {
            // http://stackoverflow.com/a/3943023/112731
            return (r * 0.299 + g * 0.587 + b * 0.114) > 186
                ? '#000000'
                : '#FFFFFF';
        }

        var padZero = function(str, len) {
            len = len || 2;
            var zeros = new Array(len).join('0');
            return (zeros + str).slice(-len);
        };

        // invert color components
        r = (255 - r).toString(16);
        g = (255 - g).toString(16);
        b = (255 - b).toString(16);
        // pad each with zeros and return
        return "#" + padZero(r) + padZero(g) + padZero(b);
    }

</script>
</body>
</html>