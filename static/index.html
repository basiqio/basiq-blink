<html>
<head>
    <title>Qantas</title>
    <script src="/js/app.js"></script>
    <script src="/js/polyfills/promise-polyfill.min.js"></script>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <h2 id="loading">Loading data...</h2>
    <div id="content">
        <h2>Select your institution</h2>
        <form id="institutionSearchForm" class="search-form">
            <input id="institutionSearch" type="text" placeholder="Search institutions">
        </form>
        <div id="institutionsContainer">
            <!--<li><a id="trigger" href="/authenticate?user_id=9743e438-02eb-41f0-858e-b41290032a03&institution_id={inst_id}&access_token={token}">Quantas</a></li>-->
        </div>
        <button style="color: #1c4765; margin: 3%; width: 94%" id="cancelBtn" class="button">Cancel</button>
    </div>
    <div id="errorContainer"></div>

<script src="/js/API.js"></script>
<script>
    document.getElementById("loading").style.display = "block";
    document.getElementById("content").style.display = "none";

    var queryVars = parseQueryVariables(),
        iFrame = !!queryVars["iframe"] && queryVars["iframe"] === "true",
        userId = queryVars["user_id"],
        accessToken = queryVars["access_token"],
        errorContainer = document.getElementById("errorContainer"),
        url = "/authenticate.html?user_id="+userId+"&institution_id={inst_id}&access_token="+accessToken;

    if (iFrame) {
        url += "&iframe=true";
    }

    if (!userId || !accessToken) {
        errorContainer.innerHTML = "Necessary parameters not provided";
    } else {
        API.loadInstitutions(accessToken).then(function (institutions) {
            document.getElementById("loading").style.display = "none";
            document.getElementById("content").style.display = "block";

            var instCont = document.getElementById("institutionsContainer");

            window.renderInstitutions(instCont, institutions, url);
        });
    }

    document.getElementById("institutionSearchForm").addEventListener("submit", institutionSearch.bind(undefined, url))
    document.getElementById("institutionSearch").addEventListener("input", institutionSearch.bind(undefined, url))
    document.getElementById("cancelBtn").addEventListener("click", function (e) {
        e.preventDefault();

        sendEventNotification("cancellation");
    });

    setTimeout(function () {
        sendEventNotification("handshake", {"success": true});
    }, 1000)
</script>
</body>
</html>