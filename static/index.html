<html>
<head>
    <title>Bank Connect</title>
    <script src="/js/app.js"></script>
    <script src="/js/polyfills/promise-polyfill.min.js"></script>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <h2 id="loading">Loading data...</h2>
    <div id="content">
        <div id="header">
            <h2 id="headerTitle">Select your bank</h2>
            <a href="#" id="closeButton"></a>
            <form id="institutionSearchForm" class="search-form">
                <div class="institution-search input-container-right">
                    <span class="ico-mglass"></span>
                    <input id="institutionSearch" type="text" placeholder="Search institutions">
                </div>
            </form>
        </div>
        <div id="institutionsContainer">
            <!--<li><a id="trigger" href="/authenticate?user_id=9743e438-02eb-41f0-858e-b41290032a03&institution_id={inst_id}&access_token={token}">Quantas</a></li>-->
        </div>
        <div id="footer" class="footer">
            <!--<button id="cancelBtn" class="button footer-button">Cancel</button>-->
            <button id="proceedBtn" class="button footer-button">Next</button>
        </div>
    </div>
    <div id="errorContainer"></div>

<script src="/js/API.js"></script>
<script>
    document.getElementById("loading").style.display = "block";
    document.getElementById("content").style.display = "none";

    var queryVars = parseQueryVariables(),
        iFrame = !!queryVars["iframe"] && queryVars["iframe"] === "true",
        userId = queryVars["user_id"],
        accessToken = queryVars["access_token"],
        showClose = !!queryVars["show_close"] && queryVars["show_close"] === "true",
        serviceTypes = queryVars["service_types"],
        countries = queryVars["countries"],
        errorContainer = document.getElementById("errorContainer"),
        proceedBtn = document.getElementById("proceedBtn"),
        footer = document.getElementById("footer"),
        url = "/authenticate.html?show_close="+showClose+"&user_id="+userId+"&institution_id={inst_id}&access_token="+accessToken,
        error = checkAccessToken(accessToken);

    if (error) {
        document.getElementById("loading").style.display = "none";
        window.errorContainer.innerHTML = error;
    } else {
        footer.style.display = "none";
        /*if (!countries) {
            document.getElementById("loading").style.display = "none";
            window.errorContainer.innerHTML = "No countries parameter provided";
        }

        countries = countries.split(",").filter(Boolean);
        serviceTypes = serviceTypes ? serviceTypes.split(",").filter(Boolean) : null;
        */
        if (showClose) {
            document.getElementById("closeButton").style.display = "block";
            document.getElementById("closeButton").addEventListener("click", function (e) {
                e.preventDefault();

                sendEventNotification("cancellation");
            });
        }

        if (iFrame) {
            url += "&iframe=true";
        }

        if (!userId || !accessToken) {
            errorContainer.innerHTML = "Necessary parameters not provided";
        } else {
            API.loadInstitutions(accessToken).then(function (institutions) {
                document.getElementById("loading").style.display = "none";
                document.getElementById("content").style.display = "block";

                var instCont = document.getElementById("institutionsContainer");

                window.renderInstitutions(instCont, institutions, url);
            });
        }

        document.getElementById("institutionSearchForm").addEventListener("submit", institutionSearch.bind(undefined, url))
        document.getElementById("institutionSearch").addEventListener("input", institutionSearch.bind(undefined, url))
        document.getElementById("institutionSearch").addEventListener("focus", function (e) {
            document.getElementById("institutionsContainer").innerHTML = "";
        });
        document.getElementById("institutionSearch").addEventListener("blur", function (e) {
            var instCont = document.getElementById("institutionsContainer"),
                term = e.target.value;

            if (term.length < 2) {
                window.renderInstitutions(instCont, institutions, url);
            }
        });
        /*document.getElementById("cancelBtn").addEventListener("click", function (e) {
            e.preventDefault();

            sendEventNotification("cancellation");
        });*/

        setTimeout(function () {
            sendEventNotification("handshake", {"success": true});
        }, 1000)
    }
</script>
</body>
</html>